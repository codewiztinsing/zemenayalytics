FROM python:3.11-slim

WORKDIR /app

# Upgrade pip, setuptools, and wheel
RUN pip install --upgrade pip setuptools wheel

# Set pip timeout
ENV PIP_DEFAULT_TIMEOUT=300

# Copy requirements and install script first for better Docker layer caching
COPY requirements/ /app/requirements/
COPY scripts/install_requirements.sh /app/scripts/

# Make install script executable
RUN chmod +x /app/scripts/install_requirements.sh

# Install Python dependencies (dev requirements include base)
RUN /app/scripts/install_requirements.sh requirements/dev.txt

# Copy the rest of the application
COPY . /app

# Make scripts executable
RUN chmod +x scripts/*.sh scripts/*.py 2>/dev/null || true

# Create directories for static, media, and logs files
RUN mkdir -p /app/staticfiles /app/media /app/logs

# Don't collect static files in dev (will be handled by runserver if needed)
# RUN python manage.py collectstatic --noinput || true

CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]

